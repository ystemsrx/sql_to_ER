<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL/DBML2ER</title>
    <link rel="stylesheet" href="https://unpkg.com/antd@5.19.1/dist/reset.css" />
    <link rel="stylesheet" href="https://unpkg.com/antd@5.19.1/dist/antd.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
    <link rel="stylesheet" href="css/style.css" />
</head>

<body>
    <a href="https://github.com/ystemsrx/ER_diagram_generator" class="github-corner" aria-label="View source on GitHub"
        target="_blank" rel="noopener noreferrer">
        <svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
            <path
                d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
                fill="currentColor" class="octo-arm"></path>
            <path
                d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                fill="currentColor" class="octo-body"></path>
        </svg>
    </a>
    <div class="app-container">
        <div class="header">
            <h1>SQL/DBMLËΩ¨ERÂõæÁîüÊàêÂô®</h1>
            <p>Âü∫‰∫éChenÊ®°ÂûãÁöÑÊï∞ÊçÆÂ∫ìËÆæËÆ°Â∑•ÂÖ∑</p>
            <p class="header-hint">üñ±Ô∏è ÂèåÂáªÁºñËæë ‚Ä¢ ÊªöËΩÆÁº©Êîæ</p>
        </div>

        <div id="root"></div>
    </div>

    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://unpkg.com/antd@5.19.1/dist/antd.min.js"></script>
    <script src="https://unpkg.com/@antv/g6@4.8.24/dist/g6.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/display/placeholder.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>

    <!-- Parser Modules -->
    <script src="js/parser-sql.js"></script>
    <script src="js/parser-dbml.js"></script>

    <!-- ER Builder Module -->
    <script src="js/builder.js"></script>

    <!-- Layout Module -->
    <script src="js/layout.js"></script>

    <!-- Editor Module -->
    <script src="js/editor.js"></script>

    <!-- Exporter Module -->
    <script src="js/exporter.js"></script>

    <!-- Main Application Script -->
    <script type="text/babel">
        window.addEventListener('load', () => {
            const { useState, useEffect, useRef } = React;
            const { Switch } = window.antd;
            const G6 = window.G6;

            // Ê≥®ÂÜå G6 Ëá™ÂÆö‰πâËäÇÁÇπÔºàentity, attribute, relationshipÔºâ
            window.ERBuilder.registerCustomNodes(G6);

            // ‰ªé ERBuilder Ê®°ÂùóËé∑ÂèñÂáΩÊï∞
            const generateChenModelData = window.ERBuilder.generateChenModelData;
            const patchRelationshipLinkPoints = window.ERBuilder.patchRelationshipLinkPoints;

            // ‰ªé Layout Ê®°ÂùóËé∑ÂèñÂ∏ÉÂ±ÄÂáΩÊï∞
            const {
                smoothFitView,
                animateNodesToTargets,
                deterministicHash,
                deterministicRandom,
                applyInitialComponentPositions,
                spreadDisconnectedComponents,
                forceAlignLayout,
                arrangeLayout
            } = window.Layout;

            // ‰ªé Editor Ê®°ÂùóËé∑Âèñ CodeEditor ÁªÑ‰ª∂
            const CodeEditor = window.Editor.createCodeEditorComponent(React);

            const App = () => {
                const [showBackground, setShowBackground] = useState(true);
                const [inputText, setInputText] = useState(`// Á§∫‰æãDBMLÔºåËØ∑Âú®Ê≠§Â§ÑÁ≤òË¥¥ÊÇ®ÁöÑ DBML Êàñ SQL ËØ≠Âè•
Table Áî®Êà∑ {
  ÁºñÂè∑ INT [pk, increment]
  Áî®Êà∑Âêç VARCHAR(255) [not null]
  ÈÇÆÁÆ± VARCHAR(255) [unique]
  ÂàõÂª∫Êó∂Èó¥ TIMESTAMP
}

Table ÂõΩÂÆ∂ {
  ÁºñÂè∑ INT [pk]
  ÂêçÁß∞ VARCHAR(255) [not null]
}

Table ÊñáÁ´† {
  ÊñáÁ´†ÁºñÂè∑ INT [pk]
  ÂÜÖÂÆπ TEXT
}

Ref: Áî®Êà∑.Â±û‰∫é > ÂõΩÂÆ∂.ÁºñÂè∑
Ref: ÊñáÁ´†.‰ΩúËÄÖ > Áî®Êà∑.ÁºñÂè∑
`);
                const [isColored, setIsColored] = useState(true);
                const [error, setError] = useState(null);
                const [loading, setLoading] = useState(false);
                const [hasGraph, setHasGraph] = useState(false);
                const lastInputRef = useRef(''); // ËÆ∞ÂΩï‰∏äÊ¨°ÁîüÊàêÊó∂ÁöÑËæìÂÖ•
                const containerRef = useRef(null);
                const graphRef = useRef(null);

                // Êõ¥Êñ∞ÂõæË°®Ê†∑Âºè
                const updateGraphStyles = (graphInstance, colored) => {
                    if (!graphInstance || graphInstance.destroyed) return;

                    graphInstance.setAutoPaint(false);

                    const nodes = graphInstance.getNodes();
                    nodes.forEach(node => {
                        const model = node.getModel();
                        const styles = {};

                        if (colored) {
                            if (model.nodeType === 'entity') {
                                // Sky Blue theme
                                styles.style = {
                                    fill: '#e0f2fe',
                                    stroke: '#0ea5e9',
                                    lineWidth: 2,
                                    radius: 8,
                                    shadowColor: 'rgba(14, 165, 233, 0.2)',
                                    shadowBlur: 10
                                };
                                styles.labelCfg = { style: { fill: '#0f172a', fontWeight: '700', fontFamily: 'Inter' } };
                            } else if (model.nodeType === 'relationship') {
                                // Violet theme
                                styles.style = {
                                    fill: '#f5f3ff',
                                    stroke: '#8b5cf6',
                                    lineWidth: 2,
                                    shadowColor: 'rgba(139, 92, 246, 0.2)',
                                    shadowBlur: 10
                                };
                                styles.labelCfg = { style: { fill: '#0f172a', fontFamily: 'Inter' } };
                            } else if (model.nodeType === 'attribute') {
                                if (model.keyType === 'pk') {
                                    // Emerald theme
                                    styles.style = {
                                        fill: '#ecfdf5',
                                        stroke: '#10b981',
                                        lineWidth: 2,
                                        shadowColor: 'rgba(16, 185, 129, 0.2)',
                                        shadowBlur: 5
                                    };
                                    styles.labelCfg = { style: { fill: '#0f172a', fontWeight: '700', fontFamily: 'Inter' } };
                                } else {
                                    // Slate theme
                                    styles.style = {
                                        fill: '#ffffff',
                                        stroke: '#94a3b8', // Slate 400
                                        lineWidth: 2
                                    };
                                    styles.labelCfg = { style: { fill: '#475569', fontWeight: 'normal', fontFamily: 'Inter' } };
                                }
                            }
                        } else {
                            // ÈªëÁôΩÊ®°Âºè (Êó†Â°´ÂÖÖ = ÁôΩËâ≤ËÉåÊôØ)
                            styles.style = {
                                fill: '#ffffff',
                                stroke: '#1e293b',
                                lineWidth: model.keyType === 'pk' || model.nodeType === 'entity' || model.nodeType === 'relationship' ? 2 : 1,
                                shadowBlur: 0
                            };
                            styles.labelCfg = { style: { fill: '#1e293b', fontWeight: (model.nodeType === 'entity' || model.keyType === 'pk') ? 'bold' : 'normal', fontFamily: 'Inter' } };
                        }

                        graphInstance.updateItem(node, styles);
                    });

                    // Âà∑Êñ∞Ëæπ
                    const edges = graphInstance.getEdges();
                    edges.forEach(edge => {
                        graphInstance.updateItem(edge, {
                            style: {
                                stroke: '#000000',
                                lineWidth: 1.5,
                                endArrow: false
                            },
                            labelCfg: {
                                style: {
                                    fill: '#000000',
                                    fontSize: 12,
                                    background: {
                                        fill: '#ffffff',
                                        padding: [2, 4, 2, 4],
                                        radius: 2
                                    }
                                }
                            }
                        });
                    });

                    graphInstance.paint();
                    graphInstance.setAutoPaint(true);
                };

                // ÁõëÂê¨ÁùÄËâ≤Áä∂ÊÄÅÂèòÂåñ
                useEffect(() => {
                    if (hasGraph && graphRef.current) {
                        updateGraphStyles(graphRef.current, isColored);
                    }
                }, [isColored, hasGraph]);


                const handleGenerate = () => {
                    try {
                        setError(null);
                        setLoading(true);

                        if (!inputText.trim()) {
                            setError("ËæìÂÖ•‰∏∫Á©∫„ÄÇ");
                            setLoading(false);
                            return;
                        }

                        // Â¶ÇÊûúËæìÂÖ•ÊîπÂèò‰∫ÜÔºåËÆ∞ÂΩïÊñ∞ËæìÂÖ•
                        if (lastInputRef.current !== inputText.trim()) {
                            lastInputRef.current = inputText.trim();
                        }

                        let parsedData;
                        const potentialSQL = inputText.trim();

                        // Try parsing as SQL first, if it fails (no tables), try DBML.
                        parsedData = parseSQLTables(potentialSQL);

                        if (parsedData.tables.length === 0) {
                            parsedData = parseDBML(potentialSQL);
                        }

                        const { tables, relationships } = parsedData;

                        if (tables.length === 0) {
                            setError("Êú™ÊâæÂà∞ÊúâÊïàÁöÑ CREATE TABLE Êàñ Table ÂÆö‰πâ„ÄÇËØ∑Á°Æ‰øùÊÇ®ÁöÑSQLÊàñDBMLËØ≠Ê≥ïÊ≠£Á°Æ„ÄÇ");
                            setLoading(false);
                            return;
                        }

                        const { nodes, edges } = generateChenModelData(tables, relationships, isColored);

                        // ÂàùÂßã‰ΩçÁΩÆÔºöÂÖàÊää‰∏çÂêåÁªÑ‰ª∂ÂàÜÂºÄÂõ¥Áªï‰∏≠ÂøÉÔºåÈÅøÂÖçÂàùÂßã‰∫§Âèâ
                        applyInitialComponentPositions(nodes, edges, containerRef.current, 0);

                        // Clear previous graph completely
                        if (graphRef.current) {
                            graphRef.current.clear(); // ÂÖàÊ∏ÖÁ©∫Êï∞ÊçÆ
                            graphRef.current.destroy(); // ÂÜçÈîÄÊØÅÂõæÂΩ¢
                            graphRef.current = null; // ÈáçÁΩÆÂºïÁî®
                        }

                        // Create G6 graph
                        const graph = new G6.Graph({
                            container: containerRef.current,
                            width: containerRef.current.offsetWidth,
                            height: containerRef.current.offsetHeight,
                            renderer: 'canvas',
                            background: '#ffffff', // ËÆæÁΩÆÁôΩËâ≤ËÉåÊôØÔºåÁ°Æ‰øùÂ§çÂà∂ÂõæÁâáÊó∂ËÉåÊôØ‰∏∫ÁôΩËâ≤
                            modes: {
                                default: [
                                    'drag-node',                         // 1. ÂÖàÂà§Êñ≠ÊãñËäÇÁÇπ
                                    {
                                        type: 'drag-canvas',
                                        allowDragOnItem: true,             // 2. ÂÖÅËÆ∏Âú® item ‰∏äÊãñÁîªÂ∏É
                                        enableOptimize: false,              //    ÔºàÊÄßËÉΩ‰ºòÂåñÔºåÂèØÁïôÂèØÂà†Ôºâ
                                        shouldBegin(e) {                   // 3. Ëá™ÂÆö‰πâÂºÄÂßãÊù°‰ª∂
                                            // e.item ‰∏∫Á©∫ = ÁúüÁ©∫ÁôΩÂ§ÑÔºõÁªÑÂêà / Ëæπ‰πüÁÆó"Èùû node"
                                            return !e.item || e.item.getType() !== 'node';
                                        }
                                    },
                                    'zoom-canvas'
                                ]
                            },

                            // ‰ºòÂåñÂêéÁöÑÂäõÂØºÂêëÂ∏ÉÂ±ÄÈÖçÁΩÆÔºå‰ª•ÂÆåÂÖ®ÈÅøÂÖçÈáçÂè†
                            layout: {
                                type: 'force2', // ‰ΩøÁî® force2 Â∏ÉÂ±Ä
                                preventOverlap: true, // Á°Æ‰øùËäÇÁÇπ‰∏çÈáçÂè†
                                // ÂøΩÁï•ÊñáÊú¨ÈïøÂ∫¶ÔºåÁªü‰∏ÄÂ§ÑÁêÜÊ§≠ÂúÜ/Ëè±ÂΩ¢Â∞∫ÂØ∏ÔºåÈÅøÂÖçÂõ†ÂÜÖÂÆπÈïøÁü≠ÈÄ†ÊàêÂ∏ÉÂ±ÄÂÅèÂ∑Æ
                                nodeSize: (node) => {
                                    const uniformSizes = {
                                        entity: 140,
                                        relationship: 90,
                                        attribute: 90
                                    };
                                    return uniformSizes[node.nodeType] || 90;
                                },
                                nodeSpacing: 20,     // Â¢ûÂä†ËäÇÁÇπÈó¥Ë∑ù
                                linkDistance: 120,   // ËøûÁ∫øÈïøÂ∫¶
                                // force2 ÁâπÂÆöÂèÇÊï∞
                                coulombDisScale: 0.005,  // Â∫ì‰ªëÂäõÁöÑÁº©ÊîæÂõ†Â≠ê
                                damping: 0.9,            // ÈòªÂ∞ºÁ≥ªÊï∞
                                maxSpeed: 1000,          // ÊúÄÂ§ßÈÄüÂ∫¶
                                minMovement: 0.5,        // ÊúÄÂ∞èÁßªÂä®Èáè
                                interval: 0.02,          // Ëø≠‰ª£Èó¥Èöî
                                factor: 1,               // Êñ•ÂäõÂõ†Â≠ê
                                maxIteration: 800,       // ÊúÄÂ§ßËø≠‰ª£Ê¨°Êï∞
                                animate: true,           // ÂêØÁî®Âä®Áîª‰ª•ÊòæÁ§∫Â∏ÉÂ±ÄËøáÁ®ã
                                center: [containerRef.current.offsetWidth / 2, 300], // Â∏ÉÂ±Ä‰∏≠ÂøÉ
                                clustering: false,       // ‰∏ç‰ΩøÁî®ËÅöÁ±ª
                                tick: () => {
                                    // ÈÄêÂ∏ßÂà∑Êñ∞‰ª•Â±ïÁé∞Ëá™Âä®Ë∞ÉÊï¥ËøáÁ®ã
                                    graph.refreshPositions();
                                },
                                onLayoutEnd: () => {
                                    // ÂÖàËÆ©‰∫í‰∏çÁõ∏ËøûÁöÑÁªÑ‰ª∂ÁéØÁªïÂàÜÂ∏ÉÔºåÈÅøÂÖçÂçÅÂ≠ó‰∫§Âèâ
                                    setTimeout(() => {
                                        if (graphRef.current && !graphRef.current.destroyed) {
                                            spreadDisconnectedComponents(graphRef.current, () => {
                                                // Â∏ÉÂ±ÄÂÆåÊàêÂêéÂπ≥ÊªëË∞ÉÊï¥ËßÜÂõæ
                                                smoothFitView(graphRef.current, 800, 'easeOutCubic');
                                            });
                                        }
                                    }, 30);
                                }
                            },
                            defaultNode: {
                                style: {
                                    lineWidth: 2,
                                    stroke: '#000',
                                    fill: '#fff'
                                },
                                labelCfg: {
                                    style: {
                                        fill: '#000',
                                        fontSize: 16  // ‰ªé12Â¢ûÂä†Âà∞16
                                    }
                                }
                            },
                            defaultEdge: {
                                style: {
                                    lineWidth: 1,
                                    stroke: '#000000'
                                },
                                labelCfg: {
                                    style: {
                                        fill: '#000000',
                                        fontSize: 14,  // ‰ªé10Â¢ûÂä†Âà∞14
                                        background: {
                                            fill: '#fff',
                                            padding: [2, 4, 2, 4]
                                        }
                                    }
                                }
                            },
                            edgeStateStyles: {
                                hover: {
                                    stroke: '#1890ff',
                                    lineWidth: 2
                                }
                            },
                            defaultEdgeConfig: {
                                type: 'line'
                            },
                            nodeStateStyles: {
                                hover: {
                                    fill: '#e6f7ff',
                                    stroke: '#1890ff'
                                }
                            }
                        });

                        graphRef.current = graph;
                        setHasGraph(true); // Ê†áËÆ∞ÂõæÂΩ¢Â∑≤ÁîüÊàê

                        // Set data and render
                        graph.data({ nodes, edges });
                        graph.render();

                        // Â∫îÁî®ÂàùÂßãÊ†∑Âºè
                        updateGraphStyles(graph, isColored);
                        // ‰øÆÊ≠£Ëè±ÂΩ¢ËøûÁ∫øËÆ°ÁÆó
                        patchRelationshipLinkPoints(graph);

                        // ÂàùÂßãÊ∏≤ÊüìÂêé‰ΩøÁî®Âπ≥ÊªëÂä®ÁîªË∞ÉÊï¥ËßÜÂõæ
                        setTimeout(() => {
                            smoothFitView(graph, 600, 'easeOutQuart');
                        }, 200);

                        // Enable interactions
                        graph.on('node:mouseenter', (e) => {
                            graph.setItemState(e.item, 'hover', true);
                        });

                        graph.on('node:mouseleave', (e) => {
                            graph.setItemState(e.item, 'hover', false);
                        });

                        // ËÆæÁΩÆËäÇÁÇπÂèåÂáªÁºñËæëÂäüËÉΩÔºà‰ΩøÁî® Editor Ê®°ÂùóÔºâ
                        window.Editor.setupNodeDoubleClickEdit(graph, containerRef.current);

                        // Ëá™ÂÆö‰πâÊãñÊãΩÈÄªËæëÔºöÊãñÂä®ÂÆû‰ΩìÊó∂Â∏¶Âä®Áõ∏ÂÖ≥Â±ûÊÄß‰∏ÄËµ∑ÁßªÂä®
                        let draggedEntity = null;
                        let relatedAttributes = [];
                        let dragStartPositions = new Map();

                        graph.on('node:dragstart', (e) => {
                            const node = e.item;
                            const nodeModel = node.getModel();

                            // Âè™Â§ÑÁêÜÂÆû‰ΩìËäÇÁÇπÁöÑÊãñÊãΩ
                            if (nodeModel.type === 'entity') {
                                draggedEntity = node;
                                relatedAttributes = [];
                                dragStartPositions.clear();

                                // ËÆ∞ÂΩïÂÆû‰ΩìÁöÑÂàùÂßã‰ΩçÁΩÆ
                                dragStartPositions.set(nodeModel.id, { x: nodeModel.x, y: nodeModel.y });

                                // ÊâæÂà∞ÊâÄÊúâÁõ∏ÂÖ≥ÁöÑÂ±ûÊÄßËäÇÁÇπ
                                const allNodes = graph.getNodes();
                                allNodes.forEach(n => {
                                    const model = n.getModel();
                                    if (model.type === 'attribute' && model.parentEntity === nodeModel.id) {
                                        relatedAttributes.push(n);
                                        // ËÆ∞ÂΩïÂ±ûÊÄßÁöÑÂàùÂßã‰ΩçÁΩÆ
                                        dragStartPositions.set(model.id, { x: model.x, y: model.y });
                                    }
                                });
                            }
                        });

                        graph.on('node:drag', (e) => {
                            const node = e.item;
                            const nodeModel = node.getModel();

                            // Âè™Â§ÑÁêÜÂÆû‰ΩìËäÇÁÇπÁöÑÊãñÊãΩ
                            if (nodeModel.type === 'entity' && draggedEntity === node) {
                                const currentPos = { x: nodeModel.x, y: nodeModel.y };
                                const startPos = dragStartPositions.get(nodeModel.id);

                                if (startPos) {
                                    // ËÆ°ÁÆóÂÆû‰ΩìÁöÑÁßªÂä®Ë∑ùÁ¶ª
                                    const deltaX = currentPos.x - startPos.x;
                                    const deltaY = currentPos.y - startPos.y;

                                    // ÂêåÊ≠•ÁßªÂä®ÊâÄÊúâÁõ∏ÂÖ≥ÁöÑÂ±ûÊÄßËäÇÁÇπ
                                    relatedAttributes.forEach(attrNode => {
                                        const attrModel = attrNode.getModel();
                                        const attrStartPos = dragStartPositions.get(attrModel.id);

                                        if (attrStartPos) {
                                            const newX = attrStartPos.x + deltaX;
                                            const newY = attrStartPos.y + deltaY;

                                            // Êõ¥Êñ∞Â±ûÊÄßËäÇÁÇπ‰ΩçÁΩÆ
                                            graph.updateItem(attrNode, { x: newX, y: newY });
                                        }
                                    });
                                }
                            }
                        });

                        graph.on('node:dragend', (e) => {
                            const node = e.item;
                            const nodeModel = node.getModel();

                            // Ê∏ÖÁêÜÊãñÊãΩÁä∂ÊÄÅ
                            if (nodeModel.type === 'entity' && draggedEntity === node) {
                                draggedEntity = null;
                                relatedAttributes = [];
                                dragStartPositions.clear();
                            }
                        });

                        // Ëá™Âä®Â∏ÉÂ±ÄËØ¥ÊòéÔºö
                        // 1. forceÂ∏ÉÂ±Ä‰ºöËá™Âä®ËÆ°ÁÆóËäÇÁÇπ‰ΩçÁΩÆÔºåÈÅøÂÖçÈáçÂè†
                        // 2. ‰∏çÂêåÁ±ªÂûãËäÇÁÇπÊúâ‰∏çÂêåÁöÑÊéíÊñ•ÂäõÂíåÈó¥Ë∑ù
                        // 3. ËøûÁ∫øÈïøÂ∫¶Ê†πÊçÆÂÖ≥Á≥ªÁ±ªÂûãËá™Âä®Ë∞ÉÊï¥
                        // 4. Â∏ÉÂ±ÄÂÆåÊàêÂêéËá™Âä®Ë∞ÉÊï¥ËßÜÂõæÂ§ßÂ∞è

                    } catch (e) {
                        console.error("SQL Parsing error:", e);
                        setError(`SQL Ëß£ÊûêÂ§±Ë¥•: ${e.message}. ËØ∑Ê£ÄÊü•SQLËØ≠Ê≥ïÊòØÂê¶Ê≠£Á°Æ„ÄÇ`);
                    } finally {
                        setLoading(false);
                    }
                };

                useEffect(() => {
                    handleGenerate();

                    // Cleanup on unmount
                    return () => {
                        if (graphRef.current) {
                            graphRef.current.destroy();
                        }
                    };
                }, []);

                const handleResize = () => {
                    if (graphRef.current && containerRef.current) {
                        graphRef.current.changeSize(
                            containerRef.current.offsetWidth,
                            containerRef.current.offsetHeight
                        );
                    }
                };

                // ÂØºÂá∫SVGÂäüËÉΩ - ‰ΩøÁî® Exporter Ê®°Âùó
                const handleExportSVG = () => {
                    window.Exporter.exportSVG({
                        graphRef: graphRef,
                        hasGraph: hasGraph,
                        containerRef: containerRef,
                        onError: setError,
                        patchRelationshipLinkPoints: patchRelationshipLinkPoints,
                        G6: G6
                    });
                };

                useEffect(() => {
                    window.addEventListener('resize', handleResize);
                    return () => window.removeEventListener('resize', handleResize);
                }, []);

                // ÂàáÊç¢ËÉåÊôØÊòæÁ§∫
                const handleToggleBackground = () => {
                    setShowBackground(!showBackground);
                };

                // Âº∫Âà∂ÂØπÈΩêÔºöÂøΩÁï•Ê§≠ÂúÜÔºå‰∏ªÈìæÊ∞¥Âπ≥ÔºåÊîØÁ∫øÈÄíÂΩíÂùáÂàÜ
                const handleForceAlign = () => {
                    if (!graphRef.current || graphRef.current.destroyed) return;
                    const containerWidth = containerRef.current?.offsetWidth || 1200;
                    forceAlignLayout(graphRef.current, containerWidth);
                };

                // ÁéØÁªïÊéíÂ∏ÉÔºöËÆ©Â±ûÊÄßÂùáÂåÄÂõ¥ÁªïÂÆû‰ΩìÔºåÂêåÊó∂ÂèØÁßªÂä®ÂÆû‰Ωì‰ª•Êª°Ë∂≥ÂÖ≥Á≥ªË∑ùÁ¶ª
                const handleArrangeLayout = () => {
                    if (!graphRef.current || graphRef.current.destroyed) return;
                    arrangeLayout(graphRef.current);
                };

                return (
                    <div className="main-content">
                        <div className="input-section">
                            <div className="card">
                                <div className="card-header">
                                    <h2 className="card-title">
                                        <span style={{ fontSize: '1.5rem' }}>üìÑ</span>
                                        SQL / DBML ËæìÂÖ•
                                    </h2>
                                </div>
                                <div className="card-content">
                                    <div style={{ height: '480px', display: 'flex', flexDirection: 'column' }}>
                                        <CodeEditor
                                            value={inputText}
                                            onChange={setInputText}
                                            placeholder="Âú®Ê≠§Â§ÑÁ≤òË¥¥ÊÇ®ÁöÑ CREATE TABLE Êàñ DBML ËØ≠Âè•..."
                                        />
                                    </div>
                                    <div className="button-group">
                                        <button
                                            className="btn btn-primary"
                                            onClick={handleGenerate}
                                            disabled={loading}
                                        >
                                            {loading ? <div className="spinner" style={{ width: 20, height: 20, borderWidth: 2 }}></div> : '‚ö° ÁîüÊàêERÂõæ'}
                                        </button>
                                        <button
                                            className="btn btn-secondary"
                                            onClick={handleExportSVG}
                                            disabled={!hasGraph}
                                        >
                                            üì• ÂØºÂá∫SVG
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="output-section">
                            <div className="card">
                                <div className="card-header" style={{ flexWrap: 'wrap', gap: '16px', height: 'auto' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '24px', flex: 1, minWidth: '300px' }}>
                                        <h2 className="card-title" style={{ whiteSpace: 'nowrap' }}>
                                            <span style={{ fontSize: '1.5rem' }}>üé®</span>
                                            ERÂõæÈ¢ÑËßà
                                        </h2>

                                        <div style={{ display: 'flex', gap: '8px', alignItems: 'center', flexWrap: 'wrap' }}>
                                            <div className="legend-item" style={{ padding: '4px 10px', fontSize: '0.8rem' }}>
                                                <div style={{ width: '10px', height: '10px', borderRadius: '3px', background: isColored ? '#e0f2fe' : '#fff', border: isColored ? '2px solid #0ea5e9' : '2px solid #1e293b' }}></div>
                                                <span>ÂÆû‰Ωì</span>
                                            </div>
                                            <div className="legend-item" style={{ padding: '4px 10px', fontSize: '0.8rem' }}>
                                                <div style={{ width: '10px', height: '10px', transform: 'rotate(45deg)', background: isColored ? '#f5f3ff' : '#fff', border: isColored ? '2px solid #8b5cf6' : '2px solid #1e293b' }}></div>
                                                <span style={{ marginLeft: '4px' }}>ÂÖ≥Á≥ª</span>
                                            </div>
                                            <div className="legend-item" style={{ padding: '4px 10px', fontSize: '0.8rem' }}>
                                                <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: isColored ? '#fff' : '#fff', border: isColored ? '2px solid #94a3b8' : '1px solid #1e293b' }}></div>
                                                <span>Â±ûÊÄß</span>
                                            </div>
                                            <div className="legend-item" style={{ padding: '4px 10px', fontSize: '0.8rem' }}>
                                                <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: isColored ? '#ecfdf5' : '#fff', border: isColored ? '2px solid #10b981' : '2px solid #1e293b' }}></div>
                                                <span style={{ fontWeight: 600, color: isColored ? '#059669' : 'inherit' }}>‰∏ªÈîÆ</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginLeft: 'auto' }}>
                                        <button
                                            className="btn btn-sm btn-accent"
                                            onClick={handleArrangeLayout}
                                            disabled={!hasGraph || loading}
                                        >
                                            ‚ú® Êô∫ËÉΩÂ∏ÉÂ±Ä
                                        </button>
                                        <button
                                            className="btn btn-sm btn-accent"
                                            onClick={handleForceAlign}
                                            disabled={!hasGraph || loading}
                                        >
                                            üìê Âº∫Âà∂ÂØπÈΩê
                                        </button>
                                    </div>
                                </div>

                                <div className="card-content" style={{ position: 'relative', padding: 0, display: 'flex', flexDirection: 'column', height: '100%' }}>
                                    {error && (
                                        <div className="error-message" style={{ margin: '20px' }}>
                                            ‚ö†Ô∏è {error}
                                        </div>
                                    )}

                                    <div className={`diagram-container ${showBackground ? '' : 'no-grid'}`} style={{ border: 'none', borderRadius: 0 }}>
                                        <div
                                            className="background-toggle"
                                            onClick={handleToggleBackground}
                                            title={showBackground ? 'ÈöêËóèËÉåÊôØ' : 'ÊòæÁ§∫ËÉåÊôØ'}
                                        >
                                            <i className={`fa-solid ${showBackground ? 'fa-eye' : 'fa-eye-slash'}`}></i>
                                        </div>
                                        <div
                                            className={`colorize-toggle ${isColored ? 'active' : ''}`}
                                            onClick={() => setIsColored(!isColored)}
                                            title={isColored ? 'ÂÖ≥Èó≠ÁùÄËâ≤' : 'ÂºÄÂêØÁùÄËâ≤'}
                                        >
                                            <i className="fa-solid fa-palette"></i>
                                        </div>
                                        {loading && (
                                            <div className="loading-overlay">
                                                <div className="spinner"></div>
                                            </div>
                                        )}
                                        <div
                                            ref={containerRef}
                                            style={{
                                                width: '100%',
                                                height: '100%',
                                                position: 'relative'
                                            }}
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(
                <React.StrictMode>
                    <App />
                </React.StrictMode>
            );
        });
    </script>
</body>

</html>